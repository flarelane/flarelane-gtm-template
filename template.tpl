___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.

___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "FlareLane",
  "categories": [
    "MARKETING",
    "ANALYTICS",
    "PERSONALIZATION"
  ],
  "brand": {
    "id": "brand_flarelane",
    "displayName": "FlareLane",
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAUAAAAFACAYAAADNkKWqAAAACXBIWXMAAAsTAAALEwEAmpwYAAAGdmlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDUgNzkuMTYzNDk5LCAyMDE4LzA4LzEzLTE2OjQwOjIyICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RFdnQ9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZUV2ZW50IyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxOSAoTWFjaW50b3NoKSIgeG1wOkNyZWF0ZURhdGU9IjIwMjAtMDYtMDJUMDA6NTI6MTErMDk6MDAiIHhtcDpNb2RpZnlEYXRlPSIyMDIwLTA2LTAyVDAwOjU3OjU4KzA5OjAwIiB4bXA6TWV0YWRhdGFEYXRlPSIyMDIwLTA2LTAyVDAwOjU3OjU4KzA5OjAwIiBkYzpmb3JtYXQ9ImltYWdlL3BuZyIgcGhvdG9zaG9wOkNvbG9yTW9kZT0iMyIgcGhvdG9zaG9wOklDQ1Byb2ZpbGU9InNSR0IgSUVDNjE5NjYtMi4xIiB4bXBNTTpEb2N1bWVudElEPSJhZG9iZTpkb2NpZDpwaG90b3Nob3A6Y2FlMjc5OTUtZTIzNS1hODRiLTk1M2UtYjFmMTI0ZGIyZjE3IiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjNkN2Y2OWRlLTlkNDAtNDcwNi05ZmZkLTZjYjUxNGE0MTJhNSIgeG1wTU06T3JpZ2luYWxEb2N1bWVudElEPSJhZG9iZTpkb2NpZDpwaG90b3Nob3A6M2YwYzQyNzQtZWJjOC03MTQ3LWE0YmUtYmRiZDhmM2MxNjYxIj4gPHhtcE1NOkhpc3Rvcnk+IDxyZGY6U2VxPiA8cmRmOmxpIHN0RXZ0OmFjdGlvbj0iY3JlYXRlZCIgc3RFdnQ6aW5zdGFuY2VJRD0ieG1wLmlpZDpmMmQ1ZDIxOC01NGNlLTQ2MmUtYTY5MS1kMDFiMTJiZGYxZmYiIHN0RXZ0OndoZW49IjIwMjAtMDYtMDJUMDA6NTI6MTErMDk6MDAiIHN0RXZ0OnNvZnR3YXJlQWdlbnQ9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE5IChNYWNpbnRvc2gpIi8+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJjb252ZXJ0ZWQiIHN0RXZ0OnBhcmFtZXRlcnM9ImZyb20gYXBwbGljYXRpb24vdm5kLmFkb2JlLnBob3Rvc2hvcCB0byBpbWFnZS9wbmciLz4gPHJkZjpsaSBzdEV2dDphY3Rpb249InNhdmVkIiBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOjNkN2Y2OWRlLTlkNDAtNDcwNi05ZmZkLTZjYjUxNGE0MTJhNSIgc3RFdnQ6d2hlbj0iMjAyMC0wNi0wMlQwMDo1Nzo1OCswOTowMCIgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKE1hY2ludG9zaCkiIHN0RXZ0OmNoYW5nZWQ9Ii8iLz4gPC9yZGY6U2VxPiA8L3htcE1NOkhpc3Rvcnk+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+bFwfoAAACDNJREFUeJzt1i2OZVUUhuHTBFXdhkBgEAQFBkdgEjgmgAY8bXoIDKJ7BiAJChQSDI6E8BMSBJ1cBKToSt26dX/2OXuv/T3PCD6z3qwHu91uAUj0Uu8BAL0IIBBLAIFYAgjEEkAglgACsQQQiCWAQCwBBGIJIBBLAIFYAgjEEkAglgACsQQQiCWAQCwBBGIJIBBLAIFYAgjEEkAglgACsQQQiCWAQCwBBGIJIBBLAIFYAgjEEkAglgACsQQQiCWAQCwBBGIJIBBLAIFYAgjEEkAglgACsQQQiCWAQCwBBGIJIBBLAIFYAgjEEkAglgACsQQQiCWAQCwBBGIJIBBLAIFYAgjEEkAglgACsQQQiCWAQCwBBGIJIBBLAIFYAgjEEkAglgACsQQQiCWAQCwBBGIJIBBLAIFYAgjEEkAglgACsQQQiPVy7wEc9sZbH+0evf5m7xn08eSHLz/5rPeImfkAB/fX7z8tf/78fe8ZbO/Jj199Kn4rE8ACRDCO+G1EAIsQwRjityEBLEQEpyd+GxPAYkRwWuLXgQAWJILTEb9OBLAoEZyG+HUkgIWJYHni15kAFieCZYnfAARwAiJYjvgNQgAnIYJliN9ABHAiIjg88RuMAE5GBIclfgMSwAmJ4HDEb1ACOCkRHIb4DUwAJyaC3Ynf4ARwciLYjfgVIIABRHBz4leEAIYQwc2IXyECGEQEVyd+xQhgGBFcjfgVJICBRLA58StKAEOJYDPiV5gABhPBi4lfcQIYTgTPJn4TEEBE8HTiNwkBZFkWETyB+E1EALkmgvcSv8kIIDeI4J3Eb0ICyC0ieIv4TUoA2UsEr4nfxASQO4mg+M1OADkoOILiF0AAuVdgBMUvhABylKAIil8QAeRoAREUvzACyEkmjqD4BRJATjZhBMUvlABylokiKH7BBJCzTRBB8QsngFykcATFDwHkcgUjKH4syyKANFIoguLHNQGkmQIRFD9uEECaGjiC4sctAkhzA0ZQ/NhLAFnFQBEUP+4kgKxmgAiKHwcJIKvqGEHx414CyOo6RFD8OIoAsokNIyh+HE0A2cwGERQ/TiKAbGrFCIofJxNANrdCBMWPswggXTSMoPhxNgGkmwYRFD8uIoB0dUEExY+LCSDdnRFB8aMJAWQIJ0RQ/GhGABnGEREUP5oSQIZyIILiR3MCyHD2RFD8WIUAMqQXIih+rObBbrfrvYED3vv46e7VV17pPYM+njz9/H3xX5EPcHC//fHH8suvv/aewfaePHv8gfitTAALEME44rcRASxCBGOI34YEsBARnJ74bUwAixHBaYlfBwJYkAhOR/w6EcCiRHAa4teRABYmguWJX2cCWJwIliV+AxDACYhgOeI3CAGchAiWIX4DEcCJiODwxG8wAjgZERyW+A1IACckgsMRv0EJ4KREcBjiNzABnJgIdid+gxPAyYlgN+JXgAAGEMHNiV8RAhhCBDcjfoUIYBARXJ34FSOAYURwNeJXkAAGEsHmxK8oAQwlgs2IX2ECGEwELyZ+xQlgOBE8m/hNQAARwdOJ3yQEkGVZRPAE4jcRAeSaCN5L/CYjgNwggncSvwkJILeI4C3iNykBZC8RvCZ+ExNA7iSC4jc7AeSg4AiKXwAB5F6BERS/EALIUYIiKH5BBJCjBURQ/MIIICeZOILiF0gAOdmEERS/UALIWSaKoPgFE0DONkEExS+cAHKRwhEUPwSQyxWMoPixLIsA0kihCIof1wSQZgpEUPy4QQBpauAIih+3CCDNDRhB8WMvAWQVA0VQ/LiTALKaASIofhwkgKyqYwTFj3sJIKvrEEHx4ygCyCY2jKD4cTQBZDMbRFD8OIkAsqkVIyh+nEwA2dwKERQ/ziKAdNEwguLH2QSQbhpEUPy4iADS1QURFD8uJoB0d0YExY8mBJAhnBBB8aMZAWQYR0RQ/GhKABnKgQiKH80JIMPZE0HxYxUCyJBeiKD4sRoBZFh/P3/+jfixJgFkSA+vrr75+osP3+29g7kJIMMRP7YigAxF/NiSADIM8WNrAsgQxI8eBJDuxI9eBJCuxI+eBJBuxI/eBJAuxI8RCCCbEz9GIYBsSvwYiQCyGfFjNALIJsSPEQkgqxM/RiWArEr8GJkAshrxY3QCyCrEjwoEkObEjyoEkKbEj0oEkGbEj2oEkCbEj4oEkIuJH1UJIBcRPyoTQM4mflQngJxF/JiBAHIy8WMWAshJxI+ZCCBHEz9mI4AcRfyYkQByL/FjVgLIQeLHzASQO4kfsxNA9hI/Egggt4gfKQSQG8SPJALINfEjjQCyLIv4kUkAET9iCWA48SOZAAYTP9IJYCjxAwGMJH7wLwEMI37wPwEMIn5wkwCGED+4TQADiB/sJ4CTEz+4mwBOTPzgMAGclPjB/QRwQuIHxxHAyTy6uvpW/OA4L/ceQDuPHj787o3XXnun9w6owgc4if/i9/azxx/sem+BKgRwAuIH5xHA4sQPzieAhYkfXEYAixI/uJwAFiR+0IYAFiN+0I4AFiJ+0JYAFiF+0J4AFiB+sA4BHJz4wXoe7HbuCsjkAwRiCSAQSwCBWAIIxBJAIJYAArEEEIglgEAsAQRiCSAQSwCBWAIIxBJAIJYAArEEEIglgEAsAQRiCSAQSwCBWAIIxBJAIJYAArEEEIglgEAsAQRiCSAQSwCBWAIIxBJAIJYAArEEEIglgEAsAQRiCSAQSwCBWAIIxBJAIJYAArEEEIglgEAsAQRiCSAQSwCBWAIIxBJAIJYAArEEEIglgEAsAQRiCSAQSwCBWAIIxBJAIJYAArEEEIj1D5T88PNgUvrtAAAAAElFTkSuQmCC"
  },
  "description": "The template using the FlareLane SDK provides features such as Track Event, Set Tags, and more. \nhttps://flarelane.com/",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "SELECT",
    "name": "method",
    "displayName": "Method",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": "trackEvent",
        "displayValue": "Track Event"
      },
      {
        "value": "setTags",
        "displayValue": "Set Tags"
      },
      {
        "value": "removeTags",
        "displayValue": "Remove Tags"
      },
      {
        "value": "setUserAttributes",
        "displayValue": "Set User Attributes"
      },
      {
        "value": "displayInApp",
        "displayValue": "Display In-App Message"
      },
      {
        "value": "setUserId",
        "displayValue": "Set User ID"
      },
      {
        "value": "removeUserId",
        "displayValue": "Remove User ID"
      },
      {
        "value": "initialize",
        "displayValue": "Initialize"
      }
    ],
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "projectId",
    "displayName": "Project ID",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "method",
        "paramValue": "initialize",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "serviceWorkerPath",
    "displayName": "Service Worker Path",
    "simpleValueType": true,
    "valueHint": "Optional",
    "enablingConditions": [
      {
        "paramName": "method",
        "paramValue": "initialize",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "userId",
    "displayName": "User ID",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "method",
        "paramValue": "setUserId",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "eventName",
    "displayName": "Event Name",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "method",
        "paramValue": "trackEvent",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "eventData",
    "displayName": "Event Data",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "Key",
        "name": "key",
        "type": "TEXT",
        "isUnique": true
      },
      {
        "defaultValue": "",
        "displayName": "Value",
        "name": "value",
        "type": "TEXT"
      }
    ],
    "newRowButtonText": "Add Data",
    "enablingConditions": [
      {
        "paramName": "method",
        "paramValue": "trackEvent",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "tags",
    "displayName": "Tags",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "Key",
        "name": "key",
        "type": "TEXT",
        "isUnique": true
      },
      {
        "defaultValue": "",
        "displayName": "Value",
        "name": "value",
        "type": "TEXT",
        "isUnique": false
      }
    ],
    "enablingConditions": [
      {
        "paramName": "method",
        "paramValue": "setTags",
        "type": "EQUALS"
      }
    ],
    "newRowButtonText": "Add Tag"
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "tagsToRemove",
    "displayName": "Tags",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "Key",
        "name": "key",
        "type": "TEXT",
        "isUnique": true
      }
    ],
    "enablingConditions": [
      {
        "paramName": "method",
        "paramValue": "removeTags",
        "type": "EQUALS"
      }
    ],
    "help": "Remove the tags.",
    "newRowButtonText": "Add Key"
  },
  {
    "type": "TEXT",
    "name": "displayInAppGroup",
    "displayName": "Group",
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "method",
        "paramValue": "displayInApp",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "userAttributes",
    "displayName": "User Attributes",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "Key",
        "name": "key",
        "type": "TEXT"
      },
      {
        "defaultValue": "",
        "displayName": "Value",
        "name": "value",
        "type": "TEXT"
      }
    ],
    "help": "For more information, see user attributes in the FlareLane docs.",
    "enablingConditions": [
      {
        "paramName": "method",
        "paramValue": "setUserAttributes",
        "type": "EQUALS"
      }
    ],
    "newRowButtonText": "Add Attributes"
  },
  {
    "type": "CHECKBOX",
    "name": "debug",
    "checkboxText": "Debug Mode",
    "simpleValueType": true,
    "help": "Enable debug mode to view logs."
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// Javascript Sandbox
// API https://developers.google.com/tag-platform/tag-manager/templates/api
// Standard Library https://developers.google.com/tag-platform/tag-manager/templates/standard-library
const copyFromWindow = require('copyFromWindow');
const callInWindow = require('callInWindow');
const createQueue = require('createQueue');
const logToConsole = require('logToConsole');
const log = data.debug ? (message) => logToConsole("GTM:FlareLane: ", message) : () => {};

// window.FlareLane이 있는 타이밍을 예측할 수 없을 때
const deferredArrayName = 'FlareLaneDeferred';
let deferred = false;
if (!copyFromWindow('FlareLane')) {
  // FlareLane 객체가 없으면 FlareLaneDeferred 큐에 삽입
  deferred = true;
  log('FlareLane cannot be found. Please install FlareLane before executing the GTM tag, and note that the "Deferred" option has been automatically enabled.');
}

// Select Box (Display Name: Method)
// 실행 시킬 FlareLane 메서드
const method = data.method;
const pathToFunction = (name) => 'FlareLane' + '.' + name;

// https://docs.flarelane.co.kr/
// ----- 메서드 분기 -----

// FlareLane.setUserId
if (method === 'setUserId') {
  const userId = data.userId;
  
  if (userId) {
    if (deferred) {
      const deferredPush = createQueue(deferredArrayName);
      deferredPush((FlareLane) => { FlareLane.setUserId(userId); });
    } else {
      callInWindow(pathToFunction('setUserId'), userId);
    }
    log('Execute "Set User ID": ' + userId);
  } else {
    log('Rejected "Set User ID", "User ID" is empty.');
  }
}

// FlareLane.setUserId
if (method === 'removeUserId') {
  if (deferred) {
    const deferredPush = createQueue(deferredArrayName);
    deferredPush((FlareLane) => { FlareLane.setUserId(null); });
  } else {
    callInWindow(pathToFunction('setUserId'), null);
  }
  log('Execute "Remove User ID"');
}

// FlareLane.trackEvent
if (method === 'trackEvent') {
  const eventName = data.eventName;
  const eventData = {};
  
  if (data.eventData && data.eventData.length > 0) {
    data.eventData.forEach((item) => {
      eventData[item.key] = item.value;
    });
  }
  
  if (eventName) {
    if (deferred) {
      const deferredPush = createQueue(deferredArrayName);
      deferredPush((FlareLane) => { FlareLane.trackEvent(eventName, eventData); });
    } else {
      callInWindow(pathToFunction('trackEvent'), eventName, eventData); 
    }
    log('Execute "Track Event": ' + eventName + ', ' + eventData.toString());
  } else {
    log('Rejected "Track Event": Event Name is missing,');
  }
}

// FlareLane.setTags
if (method === 'setTags') {
  if (data.tags && data.tags.length > 0) {
    const tags = {};
    data.tags.forEach((item) => {
      tags[item.key] = item.value;
    });
    
    // tags가 있을 때 실행
    if (deferred) {
      const deferredPush = createQueue(deferredArrayName);
      deferredPush((FlareLane) => { FlareLane.setTags(tags); });
    } else {
      callInWindow(pathToFunction('setTags'), tags);
    }
    log('Execute "Set Tags": ' + tags.toString());
  } else {
    log('"Rejected "Set Tags": tags is empty');
  }
}

// FlareLane.setTags
if (method === 'removeTags') { 
  if (data.tagsToRemove && data.tagsToRemove.length > 0) {
    const tags = {};
    data.tagsToRemove.forEach((item) => {
      tags[item.key] = null;
    });
    
    // 지울 tags가 있을 때 실행
    if (deferred) {
      const deferredPush = createQueue(deferredArrayName);
      deferredPush((FlareLane) => { FlareLane.setTags(tags); });
    } else {
      callInWindow(pathToFunction('setTags'), tags);
    }
    log('Execute "Remove Tags": ' + tags.toString());
  } else {
    log('"Rejected "Remove Tags": tags is empty');
  }
}

// Flarelane.setUserAttributes
if (method === 'setUserAttributes') {
  if (data.userAttributes && data.userAttributes.length > 0) {
    const userAttributes = {};
    data.userAttributes.forEach((item) => {
      userAttributes[item.key] = item.value;
    });
    
    if (deferred) {
      const deferredPush = createQueue(deferredArrayName);
      deferredPush((FlareLane) => { FlareLane.setUserAttributes(userAttributes); });
    } else {
      callInWindow(pathToFunction('setUserAttributes'), userAttributes);
    }
    log('Execute "Set User Attributes": ' + userAttributes.toString());
  } else {
    log('"Rejected "Set User Attributes": attributes is empty');
  }
}

// FlareLane.displayInApp
if (method ===  'displayInApp') {
  const group = data.displayInAppGroup;
  
  if (group) {
    if (deferred) {
      const deferredPush = createQueue(deferredArrayName);
      deferredPush((FlareLane) => { FlareLane.displayInApp(group); });
    } else {
      callInWindow(pathToFunction('displayInApp'), group);
    }
    log('Execute "Display In-App Message": ' + group);
  } else {
    log('Rejected "Display In-App Message": Group is missing.');
  }
}

// FlareLane.initialize
if (method ===  'initialize') {
  const projectId = data.projectId;
  const serviceWorkerPath = data.serviceWorkerPath;
  const configs = {
    projectId: projectId,
    serviceWorkerPath: serviceWorkerPath ? serviceWorkerPath : undefined,
  };
  
  if (projectId) {
    if (deferred) {
      const deferredPush = createQueue(deferredArrayName);
      deferredPush((FlareLane) => { FlareLane.initialize(configs); });
    } else {
      callInWindow(pathToFunction('initialize'), configs);
    }
    log('Execute "Initialize": ' + projectId + serviceWorkerPath ? ', ' + serviceWorkerPath : '');
  } else {
    log('Rejected "Initialize": "Project ID" is empty.');
  }
}

data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "FlareLane"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "FlareLane.setUserId"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "FlareLane.trackEvent"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "FlareLane.setTags"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "FlareLane.displayInApp"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "FlareLane.initialize"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "FlareLaneDeferred"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

setup: |-
  var mockData;

  mock('copyFromWindow', function(object) {
    if (object === 'FlareLane') {
      return {};
    }
    return undefined;
  });

  const logToConsole = require('logToConsole');
  logToConsole('Setup block executed');
scenarios:
- name: Set User ID - FlareLane Exists
  code: |-
    mockData = {
      method: 'setUserId',
      userId: 'testUser123',
      debug: true
    };

    mock('callInWindow', function(method, userId) {
      assertThat(method).isEqualTo('FlareLane.setUserId');
      assertThat(userId).isEqualTo('testUser123');
    });

    runCode(mockData);
    assertApi('callInWindow').wasCalledWith('FlareLane.setUserId', 'testUser123');
    assertApi('gtmOnSuccess').wasCalled();
- name: Set User ID - Deferred Execution
  code: |-
    mockData = {
      method: 'setUserId',
      userId: 'testUser123',
      debug: true
    };

    mock('copyFromWindow', function(object) {
      return undefined;
    });

    mock('createQueue', function(queueName) {
      assertThat(queueName).isEqualTo('FlareLaneDeferred');
      return function(callback) {
        assertThat(typeof callback).isEqualTo('function');
      };
    });

    runCode(mockData);
    assertApi('gtmOnSuccess').wasCalled();
- name: Remove User ID - FlareLane Exists
  code: |-
    mockData = {
      method: 'removeUserId',
      debug: true
    };

    mock('callInWindow', function(method, userId) {
      assertThat(method).isEqualTo('FlareLane.setUserId');
      assertThat(userId).isEqualTo(null);
    });

    runCode(mockData);
    assertApi('callInWindow').wasCalledWith('FlareLane.setUserId', null);
    assertApi('gtmOnSuccess').wasCalled();
- name: Remove User ID - Deferred Execution
  code: |-
    mockData = {
      method: 'removeUserId',
      debug: true
    };

    mock('copyFromWindow', function(object) {
      return undefined;
    });

    mock('createQueue', function(queueName) {
      assertThat(queueName).isEqualTo('FlareLaneDeferred');
      return function(callback) {
        assertThat(typeof callback).isEqualTo('function');
      };
    });

    runCode(mockData);
    assertApi('gtmOnSuccess').wasCalled();
- name: Track Event - FlareLane Exists
  code: |-
    mockData = {
      method: 'trackEvent',
      eventName: 'purchaseComplete',
      eventData: [{ key: 'price', value: '1000' }],
      debug: true
    };

    mock('callInWindow', function(method, eventName, properties) {
      assertThat(method).isEqualTo('FlareLane.trackEvent');
      assertThat(eventName).isEqualTo('purchaseComplete');
      assertThat(properties.price).isEqualTo('1000');
    });

    runCode(mockData);
    assertApi('callInWindow').wasCalledWith('FlareLane.trackEvent', 'purchaseComplete', { price: '1000' });
    assertApi('gtmOnSuccess').wasCalled();
- name: Track Event - Deferred Execution
  code: |-
    mockData = {
      method: 'trackEvent',
      eventName: 'purchaseComplete',
      eventData: [{ key: 'price', value: '1000' }],
      debug: true
    };

    mock('copyFromWindow', function(object) {
      return undefined;
    });

    mock('createQueue', function(queueName) {
      assertThat(queueName).isEqualTo('FlareLaneDeferred');
      return function(callback) {
        assertThat(typeof callback).isEqualTo('function');
      };
    });

    runCode(mockData);
    assertApi('gtmOnSuccess').wasCalled();
- name: Set Tags - FlareLane Exists
  code: |-
    mockData = {
      method: 'setTags',
      tags: [
        { key: 'grade', value: 'premium' },
        { key: 'region', value: 'APAC' }
      ],
      debug: true
    };

    mock('callInWindow', function(method, tagsObject) {
      assertThat(method).isEqualTo('FlareLane.setTags');
      assertThat(tagsObject.grade).isEqualTo('premium');
      assertThat(tagsObject.region).isEqualTo('APAC');
    });

    runCode(mockData);
    assertApi('callInWindow').wasCalledWith('FlareLane.setTags', { grade: 'premium', region: 'APAC' });
    assertApi('gtmOnSuccess').wasCalled();
- name: Remove Tags - FlareLane Exists
  code: |-
    mockData = {
      method: 'removeTags',
      tagsToRemove: [{ key: 'grade' }, { key: 'region' }],
      debug: true
    };

    mock('callInWindow', function(method, tagsObject) {
      assertThat(method).isEqualTo('FlareLane.setTags');
      assertThat(tagsObject.grade).isEqualTo(null);
      assertThat(tagsObject.region).isEqualTo(null);
    });

    runCode(mockData);
    assertApi('callInWindow').wasCalledWith('FlareLane.setTags', { grade: null, region: null });
    assertApi('gtmOnSuccess').wasCalled();
- name: Display In-App Message - FlareLane Exists
  code: |-
    mockData = {
      method: 'displayInApp',
      displayInAppGroup: 'welcomeMessage',
      debug: true
    };

    mock('callInWindow', function(method, groupName) {
      assertThat(method).isEqualTo('FlareLane.displayInApp');
      assertThat(groupName).isEqualTo('welcomeMessage');
    });

    runCode(mockData);
    assertApi('callInWindow').wasCalledWith('FlareLane.displayInApp', 'welcomeMessage');
    assertApi('gtmOnSuccess').wasCalled();
- name: Set User Attributes - FlareLane Exists
  code: |-
    mockData = {
      method: 'setUserAttributes',
      userAttributes: [
        { key: 'name', value: 'jy' },
      ],
      debug: true
    };

    mock('callInWindow', function(method, userAttributes) {
      assertThat(method).isEqualTo('FlareLane.setUserAttributes');
      assertThat(userAttributes.name).isEqualTo('jy');
    });

    runCode(mockData);
    assertApi('callInWindow').wasCalledWith('FlareLane.setUserAttributes', { name: 'jy' });
    assertApi('gtmOnSuccess').wasCalled();
- name: Set User Attributes - Deferred Execution
  code: |-
    mockData = {
      method: 'setUserAttributes',
      userAttributes: [{ key: 'name', value: 'jy' }],
      debug: true
    };

    mock('copyFromWindow', function(object) {
      return undefined;
    });

    mock('createQueue', function(queueName) {
      assertThat(queueName).isEqualTo('FlareLaneDeferred');
      return function(callback) {
        assertThat(typeof callback).isEqualTo('function');
      };
    });

    runCode(mockData);
    assertApi('gtmOnSuccess').wasCalled();
- name: Initialize - FlareLane Exists
  code: |-
    mockData = {
      method: 'initialize',
      projectId: 'my_flarelane_project',
      serviceWorkerPath: '/sw.js',
      debug: true
    };

    mock('callInWindow', function(method, configObj) {
      assertThat(method).isEqualTo('FlareLane.initialize');
      assertThat(configObj.projectId).isEqualTo('my_flarelane_project');
      assertThat(configObj.serviceWorkerPath).isEqualTo('/sw.js');
    });

    runCode(mockData);
    assertApi('callInWindow').wasCalledWith('FlareLane.initialize', { projectId: 'my_flarelane_project', serviceWorkerPath: '/sw.js' });
    assertApi('gtmOnSuccess').wasCalled();


___NOTES___

Created on 2025. 2. 21. 오전 11:20:46


